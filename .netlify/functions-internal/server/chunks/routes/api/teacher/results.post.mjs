import{d as e,e as s,c as t,r as a,a as n}from"../../../_/nitro.mjs";import"@tidbcloud/serverless";import"node:crypto";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@iconify/utils";import"consola";import"node:fs";import"node:path";const o=e(async e=>{var o,r,c,i,m,_,l;const d=await s(e);if("teacher"!==d.user.role&&"admin"!==d.user.role)throw t({statusCode:403,message:"Unauthorized"});const u=await a(e),p=n();try{const e="\n      INSERT INTO term_reports (\n        student_id, session, term, class_level, \n        class_teacher_comment, head_teacher_comment,\n        total_paces, pace_average, days_absent, next_term_begins, reading_comprehension\n      ) \n      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n      ON DUPLICATE KEY UPDATE\n        class_teacher_comment = VALUES(class_teacher_comment),\n        head_teacher_comment = VALUES(head_teacher_comment),\n        total_paces = VALUES(total_paces),\n        pace_average = VALUES(pace_average),\n        days_absent = VALUES(days_absent),\n        next_term_begins = VALUES(next_term_begins),\n        reading_comprehension = VALUES(reading_comprehension)\n    ";if(await p.execute(e,[u.student_id,u.session,u.term,u.class_level,(null==(o=u.comments)?void 0:o.teacher)||"",(null==(r=u.comments)?void 0:r.principal)||"",(null==(c=u.summary)?void 0:c.total_paces)||null,(null==(i=u.summary)?void 0:i.pace_average)||null,(null==(m=u.summary)?void 0:m.days_absent)||0,(null==(_=u.summary)?void 0:_.next_term_begins)||null,(null==(l=u.summary)?void 0:l.reading_comprehension)||null]),await p.execute("DELETE FROM academic_records WHERE student_id = ? AND session = ? AND term = ?",[u.student_id,u.session,u.term]),u.academics&&u.academics.length>0){const e=[],s=[];for(const t of u.academics)e.push(u.student_id,d.user.id,u.session,u.term,u.class_level,t.subject,t.ca1||0,t.ca2||0,t.assignment||0,t.class_ex||0,t.affective||0,t.psychomotor||0,t.exam||0),s.push("(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");if(s.length>0){const t=`\n          INSERT INTO academic_records \n          (student_id, teacher_id, session, term, class_level, subject, \n           ca1_score, ca2_score, assignment_score, class_exercise_score, \n           affective_score, psychomotor_score, exam_score)\n          VALUES ${s.join(", ")}\n        `;await p.execute(t,e)}}return{success:!0,message:"Results saved successfully"}}catch(e){throw console.error("Save Results Error:",e),t({statusCode:500,message:e.message||"Database error"})}});export{o as default};
//# sourceMappingURL=results.post.mjs.map
