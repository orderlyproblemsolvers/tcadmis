import{d as e,e as o,c as s,r as a,a as t}from"../../../_/nitro.mjs";import r from"bcryptjs";import"@tidbcloud/serverless";import"node:crypto";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@iconify/utils";import"consola";import"node:fs";import"node:path";const n=e(async e=>{console.log("--- STARTING USER CREATION ---");if("admin"!==(await o(e)).user.role)throw s({statusCode:403,message:"Unauthorized"});const n=await a(e);if(console.log("1. Received Body:",{email:n.email,name:n.full_name}),!n.email||!n.full_name||!n.password)throw s({statusCode:400,message:"Missing required fields"});const l=t();try{const e=await r.genSalt(10),o=await r.hash(n.password,e);console.log("2. Inserting into Users table...");const s=await l.execute("INSERT INTO users (email, password_hash, full_name, role) VALUES (?, ?, ?, 'teacher')",[n.email,o,n.full_name]);console.log("3. Database Result Object:",JSON.stringify(s,null,2));let a=s.insertId||s.lastInsertId;if(!a){console.log("⚠️ Warning: ID not returned directly. Fetching manually...");const e=await l.execute("SELECT id FROM users WHERE email = ?",[n.email]),o=Array.isArray(e)?e:e.rows;o&&o.length>0&&(a=o[0].id)}if(console.log("4. New User ID:",a),!a)throw new Error("CRITICAL: Could not determine new User ID.");console.log("5. Inserting into Profiles table...");const t="\n      INSERT INTO profiles_teacher (\n        user_id, photo_url, qualification, phone, address,\n        guarantor_name, guarantor_phone, guarantor_rel\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n    ";return await l.execute(t,[a,n.photo_url||null,n.qualification||null,n.phone||null,n.address||null,n.guarantor_name||null,n.guarantor_phone||null,n.guarantor_rel||null]),console.log("✅ SUCCESS: Teacher created."),{success:!0,message:"Teacher account created successfully"}}catch(e){if(console.error("❌ FATAL ERROR:",e),e.message&&(e.message.includes("Duplicate entry")||"ER_DUP_ENTRY"===e.code))throw s({statusCode:409,message:"Email already exists"});throw s({statusCode:500,message:`DB Error: ${e.message}`})}});export{n as default};
//# sourceMappingURL=users.post.mjs.map
